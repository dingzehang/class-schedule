<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¤¾ç¾¤å½•è¯¾æ’ç­è¡¨</title>
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
<style>
    body { font-family: "Microsoft YaHei", sans-serif; background-color: #f4f7f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; user-select: none; }
    .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; position: relative; overflow: hidden; }
    h2 { color: #333; margin-bottom: 10px; }
    .date-info { color: #666; font-size: 0.9em; margin-bottom: 20px; }
    
    /* æ’ç­åˆ—è¡¨ */
    #scheduleList { display: block; }
    .role-box { background: #eef2f5; margin: 10px 0; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
    .role-name { font-weight: bold; color: #2c3e50; }
    .teacher-name { font-size: 1.2em; color: #007bff; font-weight: bold; }
    .skip-box { background: #fff3cd; color: #856404; }
    .skip-box .teacher-name { color: #856404; font-size: 1em; }

    /* å†»ç»“æ¨¡å¼ç•Œé¢ */
    .freeze-view { display: none; padding: 20px 0; animation: fadeIn 0.5s; }
    .freeze-icon { font-size: 4em; margin-bottom: 15px; display: block; }
    .freeze-sub { color: #888; font-size: 0.9em; margin-top: 10px; }
    #holidayMode .freeze-text { color: #28a745; font-size: 1.2em; font-weight: bold; }
    #tempFreezeMode .freeze-text { color: #fd7e14; font-size: 1.2em; font-weight: bold; }

    /* åº•éƒ¨åŒºåŸŸ */
    .footer { margin-top: 20px; font-size: 0.8em; color: #aaa; cursor: pointer; padding: 10px; border-radius: 5px; }
    
    /* ç®¡ç†é¢æ¿ */
    #adminModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 340px; text-align: center; }
    .modal-btn { margin: 5px 0; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; width: 100%; font-weight: bold; transition: 0.2s; }
    
    .btn-holiday { background: #28a745; color: white; } 
    .btn-temp { background: #fd7e14; color: white; }    
    .btn-resume { background: #007bff; color: white; }  
    
    /* è°ƒæ•´æŒ‰é’®æ ·å¼ */
    .adjust-group { display: flex; gap: 10px; margin-top: 10px; }
    .btn-adjust { flex: 1; padding: 10px; font-size: 13px; color: white; }
    
    /* ğŸ”´ é¢œè‰²ä¿®æ­£ */
    .btn-red { background: #dc3545; }   /* çº¢è‰²ï¼šå¾€åé€€ */
    .btn-green { background: #28a745; } /* ç»¿è‰²ï¼šå¾€å‰è¿› */
    
    .btn-close { background: #6c757d; color: white; margin-top: 15px; }
    .divider { height: 1px; background: #eee; margin: 15px 0; }

    /* é¢„è§ˆåŒºæ ·å¼ */
    .preview-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: left; }
    .preview-title { font-size: 0.85em; color: #666; margin-bottom: 5px; border-bottom: 1px solid #ddd; padding-bottom: 5px; font-weight: bold; }
    .preview-row { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 0.95em; color: #333; }
    .preview-val { font-weight: bold; color: #007bff; }
    .preview-skip-val { font-weight: bold; color: #856404; font-size: 0.9em;} 
    
    .loading-mask { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 20; display: flex; justify-content: center; align-items: center; color: #666; font-size: 0.9rem; flex-direction: column;}
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div class="card">
    <div id="loadingMask" class="loading-mask">
        <div style="font-size: 2em; margin-bottom: 10px;">â˜ï¸</div>
        æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...
    </div>

    <h2>ğŸ“… ç¤¾ç¾¤å½•è¯¾æ’ç­è¡¨</h2>
    <div class="date-info" id="currentDate"></div>
    
    <div id="scheduleList">
        <div class="role-box"><span class="role-name">åˆä¸€</span><span class="teacher-name" id="g1">--</span></div>
        <div class="role-box"><span class="role-name">åˆäºŒ</span><span class="teacher-name" id="g2">--</span></div>
        <div class="role-box"><span class="role-name">åˆä¸‰</span><span class="teacher-name" id="g3">--</span></div>
        <div class="role-box skip-box"><span class="role-name">â˜• è½®ç©º</span><span class="teacher-name" id="skip">--</span></div>
    </div>

    <div id="holidayMode" class="freeze-view">
        <span class="freeze-icon">ğŸ–ï¸</span>
        <div class="freeze-text">å¯’æš‘å‡æš‚åœä¸­</div>
        <div class="freeze-sub">è¿›åº¦å·²å†»ç»“ï¼Œå®‰å¿ƒåº¦å‡ï¼</div>
        <div style="font-size:0.8em; color:#999; margin-top:15px;" class="freeze-info"></div>
    </div>
    <div id="tempFreezeMode" class="freeze-view">
        <span class="freeze-icon">â¸ï¸</span>
        <div class="freeze-text">ä¸´æ—¶æš‚åœæ’ç­</div>
        <div class="freeze-sub">ç‰¹æ®Šæƒ…å†µå¤„ç†ä¸­ï¼Œè¿›åº¦å·²ä¿ç•™</div>
        <div style="font-size:0.8em; color:#999; margin-top:15px;" class="freeze-info"></div>
    </div>

    <div class="footer" id="secretTrigger" title="è¿ç»­ç‚¹å‡»5æ¬¡æ‰“å¼€è®¾ç½®">
        åŸºå‡†æ—¥ï¼š2025-12-01 (åº·ç‹çŸ³ä½•ä¸)
    </div>
</div>

<div id="adminModal">
    <div class="modal-content">
        <h3>âš™ï¸ äº‘ç«¯ç®¡ç†åå°</h3>
        <p style="font-size:0.85em; color:#666;">å½“å‰çŠ¶æ€ï¼š<span id="modalStatusText">è¯»å–ä¸­...</span></p>
        <div id="syncStatus" style="font-size:0.75em; color:#999; margin-bottom:5px; height:15px;"></div>
        
        <div id="runningControls">
            <button class="modal-btn btn-holiday" onclick="startFreeze('holiday')">ğŸ–ï¸ å¼€å¯å¯’æš‘å‡ (é•¿æœŸ)</button>
            <button class="modal-btn btn-temp" onclick="startFreeze('temp')">â¸ï¸ å¼€å¯ä¸´æ—¶å†»ç»“ (çŸ­æœŸ)</button>
        </div>
        
        <div id="pausedControls" style="display:none;">
            <button class="modal-btn btn-resume" onclick="endFreeze()">â–¶ï¸ æ¢å¤æ­£å¸¸æ’ç­</button>
        </div>
        
        <div class="divider"></div>
        
        <div class="preview-card">
            <div class="preview-title">ğŸ‘€ è°ƒæ•´é¢„è§ˆ (å½“å‰åç§»: <span id="offsetVal">0</span>)</div>
            <div class="preview-row"><span>åˆä¸€:</span> <span class="preview-val" id="pre-g1">--</span></div>
            <div class="preview-row"><span>åˆäºŒ:</span> <span class="preview-val" id="pre-g2">--</span></div>
            <div class="preview-row"><span>åˆä¸‰:</span> <span class="preview-val" id="pre-g3">--</span></div>
            <div class="preview-row"><span>â˜•è½®ç©º:</span> <span class="preview-skip-val" id="pre-skip">--</span></div>
        </div>

        <div class="adjust-group">
            <button class="modal-btn btn-adjust btn-red" onclick="adjustOffset(-1)">âª å¾€åè°ƒ (-1)</button>
            <button class="modal-btn btn-adjust btn-green" onclick="adjustOffset(1)">â© å¾€å‰è°ƒ (+1)</button>
        </div>

        <button class="modal-btn btn-close" onclick="closeAdmin()">å…³é—­ / è¿”å›</button>
    </div>
</div>

<script>
    // ================= é…ç½®åŒº =================
    const LC_APP_ID = "1OHISQN99CFPAQn6K0aZQRpm-gzGzoHsz"; 
    const LC_APP_KEY = "y0pWlEyJrFr3P4LYu7GkIYfK";
    const LC_SERVER_URL = "https://1ohisqn9.lc-cn-n1-shared.com"; 

    const DB_CLASS_NAME = 'ClassScheduleConfig'; 
    const baseDate = new Date('2025-12-01T00:00:00');
    // åˆ—è¡¨é¡ºåºï¼šåº·(0), ç‹(1), çŸ³(2), ä½•(3), ä¸(4)
    const teachers = ["åº·åº·è€å¸ˆ", "ç‹è€å¸ˆ", "çŸ³è€å¸ˆ", "ä½•è€å¸ˆ", "ä¸è€å¸ˆ"];
    const ADMIN_PASSWORD = "888"; 
    // =========================================

    let globalState = { freezeMode: 'none', offset: 0, frozenEffective: 0, objectId: null };
    let isCloudReady = false;

    if (typeof AV === 'undefined') {
        document.getElementById('loadingMask').innerHTML = "è„šæœ¬åŠ è½½å¤±è´¥<br>è¯·æ£€æŸ¥ç½‘ç»œ";
    } else {
        try {
            AV.init({ appId: LC_APP_ID, appKey: LC_APP_KEY, serverURLs: LC_SERVER_URL });
            isCloudReady = true;
            fetchCloudData();
        } catch(e) { console.error(e); }
    }

    async function fetchCloudData() {
        if(!isCloudReady) return;
        const query = new AV.Query(DB_CLASS_NAME);
        try {
            const results = await query.find();
            if (results.length > 0) {
                const data = results[0];
                globalState.freezeMode = data.get('freezeMode') || 'none';
                globalState.offset = data.get('offset') || 0;
                globalState.frozenEffective = data.get('frozenEffective') || 0;
                globalState.objectId = data.id;
            } else {
                const Config = AV.Object.extend(DB_CLASS_NAME);
                const config = new Config();
                config.set('freezeMode', 'none');
                config.set('offset', 0);
                config.set('frozenEffective', 0);
                
                const acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                config.setACL(acl);

                const saved = await config.save();
                globalState.objectId = saved.id;
            }
            document.getElementById('loadingMask').style.display = 'none';
            updateUI(); 
        } catch (error) {
            console.error(error);
            document.getElementById('loadingMask').innerHTML = "è¿æ¥å¤±è´¥<br><button onclick='location.reload()'>é‡è¯•</button>";
        }
    }

    async function saveToCloud() {
        if(!globalState.objectId) return;
        const statusDiv = document.getElementById('syncStatus');
        statusDiv.innerText = "â³ æ­£åœ¨åŒæ­¥...";
        statusDiv.style.color = "orange";
        
        const config = AV.Object.createWithoutData(DB_CLASS_NAME, globalState.objectId);
        config.set('freezeMode', globalState.freezeMode);
        config.set('offset', globalState.offset);
        config.set('frozenEffective', globalState.frozenEffective);
        
        try {
            await config.save();
            statusDiv.innerText = "âœ… åŒæ­¥æˆåŠŸ";
            statusDiv.style.color = "green";
            setTimeout(() => statusDiv.innerText = "", 2000);
            updateUI();
        } catch (error) {
            alert("åŒæ­¥å¤±è´¥ï¼š" + error.message);
            statusDiv.innerText = "âŒ å¤±è´¥";
            statusDiv.style.color = "red";
        }
    }

    function getRealWeeks() {
        const today = new Date();
        const diffTime = today - baseDate;
        return Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
    }

    function calculateRosterList() {
        const realWeeks = getRealWeeks();
        // ğŸ”´ æ ¸å¿ƒä¿®æ­£ï¼šOffset é€»è¾‘æ”¹ä¸º (è‡ªç„¶å‘¨ + åç§»é‡)
        // è¿™æ · +1 å°±æ˜¯å¾€åèµ°(ä¸‹ä¸€äºº)ï¼Œ-1 å°±æ˜¯å¾€å‰èµ°(ä¸Šä¸€äºº)
        const effectiveWeeks = realWeeks + globalState.offset;

        let shift = effectiveWeeks % 5;
        if (shift < 0) shift = 5 + shift;

        const list = [];
        for (let i = 0; i < 5; i++) {
            let originalIndex = (i + shift) % 5; // ç®€åŒ–ç®—æ³•ï¼Œç›´æ¥æŒ‰åç§»å–
            list.push(teachers[originalIndex]);
        }
        return list; 
    }

    function updateUI() {
        const today = new Date();
        document.getElementById('currentDate').innerText = today.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

        const currentList = calculateRosterList();
        
        // æ›´æ–°ä¸»ç•Œé¢ (æ— ä»»ä½•è­¦å‘Š)
        document.getElementById('g1').innerText = currentList[0];
        document.getElementById('g2').innerText = currentList[1];
        document.getElementById('g3').innerText = currentList[2];
        document.getElementById('skip').innerText = currentList[3] + "ã€" + currentList[4];

        // æ›´æ–°åå°é¢„è§ˆ
        document.getElementById('pre-g1').innerText = currentList[0];
        document.getElementById('pre-g2').innerText = currentList[1];
        document.getElementById('pre-g3').innerText = currentList[2];
        document.getElementById('pre-skip').innerText = currentList[3] + "ã€" + currentList[4];
        document.getElementById('offsetVal').innerText = globalState.offset;

        const listDiv = document.getElementById('scheduleList');
        const holidayDiv = document.getElementById('holidayMode');
        const tempDiv = document.getElementById('tempFreezeMode');
        const runCtrl = document.getElementById('runningControls');
        const pauseCtrl = document.getElementById('pausedControls');
        const modalStatus = document.getElementById('modalStatusText');

        listDiv.style.display = 'none';
        holidayDiv.style.display = 'none';
        tempDiv.style.display = 'none';

        const freezeInfoText = globalState.frozenEffective ? `(è¿›åº¦å·²å†»ç»“åœ¨ç¬¬ ${globalState.frozenEffective} è½®)` : '';

        if (globalState.freezeMode === 'holiday') {
            holidayDiv.style.display = 'block';
            document.querySelectorAll('.freeze-info').forEach(el => el.innerText = freezeInfoText);
            runCtrl.style.display = 'none';
            pauseCtrl.style.display = 'block';
            modalStatus.innerText = "ğŸ–ï¸ å‡æœŸæš‚åœä¸­";
            modalStatus.style.color = "#28a745";

        } else if (globalState.freezeMode === 'temp') {
            tempDiv.style.display = 'block';
            document.querySelectorAll('.freeze-info').forEach(el => el.innerText = freezeInfoText);
            runCtrl.style.display = 'none';
            pauseCtrl.style.display = 'block';
            modalStatus.innerText = "â¸ï¸ ä¸´æ—¶å†»ç»“ä¸­";
            modalStatus.style.color = "#fd7e14";

        } else {
            listDiv.style.display = 'block';
            runCtrl.style.display = 'block';
            pauseCtrl.style.display = 'none';
            modalStatus.innerText = "ğŸ”„ æ­£å¸¸è½®è½¬ä¸­";
            modalStatus.style.color = "#007bff";
        }
    }

    // ================= æ“ä½œé€»è¾‘ =================
    window.startFreeze = function(type) {
        const currentReal = getRealWeeks();
        const currentEffective = currentReal + globalState.offset; // é€»è¾‘åŒæ­¥ä¿®æ”¹
        globalState.frozenEffective = currentEffective;
        globalState.freezeMode = type;
        saveToCloud().then(() => {
            alert((type === 'holiday' ? "å¯’æš‘å‡" : "ä¸´æ—¶å†»ç»“") + "å·²å¼€å¯ï¼");
        });
    }

    window.endFreeze = function() {
        if (globalState.frozenEffective !== null) {
            const currentReal = getRealWeeks();
            // æ¢å¤é€»è¾‘ï¼šOffset = å†»ç»“æ—¶çš„è¿›åº¦ - ç°åœ¨çš„çœŸå®æ—¶é—´
            globalState.offset = globalState.frozenEffective - currentReal;
        }
        globalState.freezeMode = 'none';
        globalState.frozenEffective = 0; 
        saveToCloud().then(() => {
            alert(`æ’ç­å·²æ¢å¤ï¼`);
        });
    }

    window.adjustOffset = function(change) {
        globalState.offset += change;
        updateUI(); // ç«‹å³é¢„è§ˆ
        saveToCloud(); // é™é»˜åŒæ­¥
    }

    let clickCount = 0;
    let clickTimer = null;
    document.getElementById('secretTrigger').addEventListener('click', () => {
        clickCount++;
        clearTimeout(clickTimer);
        clickTimer = setTimeout(() => { clickCount = 0; }, 1000);
        if (clickCount >= 5) {
            clickCount = 0;
            if (prompt("è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š") === ADMIN_PASSWORD) {
                document.getElementById('adminModal').style.display = 'flex';
                updateUI(); 
            }
        }
    });

    function closeAdmin() { document.getElementById('adminModal').style.display = 'none'; }
    document.getElementById('adminModal').addEventListener('click', (e) => { 
        if (e.target === document.getElementById('adminModal')) closeAdmin(); 
    });

    setInterval(updateUI, 1000 * 60 * 60);
</script>

</body>
</html>
